<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.24">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Craig Parylo">
<meta name="dcterms.date" content="2024-02-28">

<title>Visualising participant recruitment in R using Sankey plots – Data Science @ The Strategy Unit</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../../">
<script src="../../../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../../../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../../../site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="../../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../../site_libs/quarto-html/quarto-syntax-highlighting-dc55a5b9e770e841cd82e46aadbfb9b0.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="../../../site_libs/quarto-html/quarto-syntax-highlighting-dark-b651517ce65839d647a86e2780455cfb.css" rel="stylesheet" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<link href="../../../site_libs/quarto-html/quarto-syntax-highlighting-dc55a5b9e770e841cd82e46aadbfb9b0.css" rel="stylesheet" class="quarto-color-scheme-extra" id="quarto-text-highlighting-styles">
<script src="../../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../../site_libs/bootstrap/bootstrap-537d55d0a98b9865d141b35fbe103d1e.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="../../../site_libs/bootstrap/bootstrap-dark-d6d8ac3de9ecebd9a4b5d227c354be7e.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<link href="../../../site_libs/bootstrap/bootstrap-537d55d0a98b9865d141b35fbe103d1e.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme-extra" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<link href="../../../site_libs/htmltools-fill-0.5.8.1/fill.css" rel="stylesheet">
<script src="../../../site_libs/htmlwidgets-1.6.4/htmlwidgets.js"></script>
<script src="../../../site_libs/plotly-binding-4.10.4/plotly.js"></script>
<script src="../../../site_libs/typedarray-0.1/typedarray.min.js"></script>
<script src="../../../site_libs/jquery-3.5.1/jquery.min.js"></script>
<link href="../../../site_libs/crosstalk-1.2.1/css/crosstalk.min.css" rel="stylesheet">
<script src="../../../site_libs/crosstalk-1.2.1/js/crosstalk.min.js"></script>
<link href="../../../site_libs/plotly-htmlwidgets-css-2.11.1/plotly-htmlwidgets.css" rel="stylesheet">
<script src="../../../site_libs/plotly-main-2.11.1/plotly-latest.min.js"></script>
<script src="../../../site_libs/core-js-2.5.3/shim.min.js"></script>
<script src="../../../site_libs/react-18.2.0/react.min.js"></script>
<script src="../../../site_libs/react-18.2.0/react-dom.min.js"></script>
<script src="../../../site_libs/reactwidget-2.0.0/react-tools.js"></script>
<link href="../../../site_libs/reactable-0.4.4/reactable.css" rel="stylesheet">
<script src="../../../site_libs/reactable-binding-0.4.4/reactable.js"></script>


</head>

<body class="nav-fixed quarto-light"><script id="quarto-html-before-body" type="application/javascript">
    const toggleBodyColorMode = (bsSheetEl) => {
      const mode = bsSheetEl.getAttribute("data-mode");
      const bodyEl = window.document.querySelector("body");
      if (mode === "dark") {
        bodyEl.classList.add("quarto-dark");
        bodyEl.classList.remove("quarto-light");
      } else {
        bodyEl.classList.add("quarto-light");
        bodyEl.classList.remove("quarto-dark");
      }
    }
    const toggleBodyColorPrimary = () => {
      const bsSheetEl = window.document.querySelector("link#quarto-bootstrap:not([rel=disabled-stylesheet])");
      if (bsSheetEl) {
        toggleBodyColorMode(bsSheetEl);
      }
    }
    const setColorSchemeToggle = (alternate) => {
      const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
      for (let i=0; i < toggles.length; i++) {
        const toggle = toggles[i];
        if (toggle) {
          if (alternate) {
            toggle.classList.add("alternate");
          } else {
            toggle.classList.remove("alternate");
          }
        }
      }
    };
    const toggleColorMode = (alternate) => {
      // Switch the stylesheets
      const primaryStylesheets = window.document.querySelectorAll('link.quarto-color-scheme:not(.quarto-color-alternate)');
      const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
      manageTransitions('#quarto-margin-sidebar .nav-link', false);
      if (alternate) {
        // note: dark is layered on light, we don't disable primary!
        enableStylesheet(alternateStylesheets);
        for (const sheetNode of alternateStylesheets) {
          if (sheetNode.id === "quarto-bootstrap") {
            toggleBodyColorMode(sheetNode);
          }
        }
      } else {
        disableStylesheet(alternateStylesheets);
        enableStylesheet(primaryStylesheets)
        toggleBodyColorPrimary();
      }
      manageTransitions('#quarto-margin-sidebar .nav-link', true);
      // Switch the toggles
      setColorSchemeToggle(alternate)
      // Hack to workaround the fact that safari doesn't
      // properly recolor the scrollbar when toggling (#1455)
      if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
        manageTransitions("body", false);
        window.scrollTo(0, 1);
        setTimeout(() => {
          window.scrollTo(0, 0);
          manageTransitions("body", true);
        }, 40);
      }
    }
    const disableStylesheet = (stylesheets) => {
      for (let i=0; i < stylesheets.length; i++) {
        const stylesheet = stylesheets[i];
        stylesheet.rel = 'disabled-stylesheet';
      }
    }
    const enableStylesheet = (stylesheets) => {
      for (let i=0; i < stylesheets.length; i++) {
        const stylesheet = stylesheets[i];
        if(stylesheet.rel !== 'stylesheet') { // for Chrome, which will still FOUC without this check
          stylesheet.rel = 'stylesheet';
        }
      }
    }
    const manageTransitions = (selector, allowTransitions) => {
      const els = window.document.querySelectorAll(selector);
      for (let i=0; i < els.length; i++) {
        const el = els[i];
        if (allowTransitions) {
          el.classList.remove('notransition');
        } else {
          el.classList.add('notransition');
        }
      }
    }
    const isFileUrl = () => {
      return window.location.protocol === 'file:';
    }
    const hasAlternateSentinel = () => {
      let styleSentinel = getColorSchemeSentinel();
      if (styleSentinel !== null) {
        return styleSentinel === "alternate";
      } else {
        return false;
      }
    }
    const setStyleSentinel = (alternate) => {
      const value = alternate ? "alternate" : "default";
      if (!isFileUrl()) {
        window.localStorage.setItem("quarto-color-scheme", value);
      } else {
        localAlternateSentinel = value;
      }
    }
    const getColorSchemeSentinel = () => {
      if (!isFileUrl()) {
        const storageValue = window.localStorage.getItem("quarto-color-scheme");
        return storageValue != null ? storageValue : localAlternateSentinel;
      } else {
        return localAlternateSentinel;
      }
    }
    const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
      const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
      const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
      let newTheme = '';
      if(authorPrefersDark) {
        newTheme = isAlternate ? baseTheme : alternateTheme;
      } else {
        newTheme = isAlternate ? alternateTheme : baseTheme;
      }
      const changeGiscusTheme = () => {
        // From: https://github.com/giscus/giscus/issues/336
        const sendMessage = (message) => {
          const iframe = document.querySelector('iframe.giscus-frame');
          if (!iframe) return;
          iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
        }
        sendMessage({
          setConfig: {
            theme: newTheme
          }
        });
      }
      const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
      if (isGiscussLoaded) {
        changeGiscusTheme();
      }
    };
    const authorPrefersDark = false;
    const darkModeDefault = authorPrefersDark;
      document.querySelector('link#quarto-text-highlighting-styles.quarto-color-scheme-extra').rel = 'disabled-stylesheet';
      document.querySelector('link#quarto-bootstrap.quarto-color-scheme-extra').rel = 'disabled-stylesheet';
    let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
    // Dark / light mode switch
    window.quartoToggleColorScheme = () => {
      // Read the current dark / light value
      let toAlternate = !hasAlternateSentinel();
      toggleColorMode(toAlternate);
      setStyleSentinel(toAlternate);
      toggleGiscusIfUsed(toAlternate, darkModeDefault);
      window.dispatchEvent(new Event('resize'));
    };
    // Switch to dark mode if need be
    if (hasAlternateSentinel()) {
      toggleColorMode(true);
    } else {
      toggleColorMode(false);
    }
  </script>

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a href="../../../index.html" class="navbar-brand navbar-brand-logo">
    </a>
    <a class="navbar-brand" href="../../../index.html">
    <span class="navbar-title">Data Science @ The Strategy Unit</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../../index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../about.html"> 
<span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../blogs/index.html"> 
<span class="menu-text">Blogs</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../presentations/index.html"> 
<span class="menu-text">Presentations</span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-how-we-work" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">How we work</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-how-we-work">    
        <li>
    <a class="dropdown-item" href="../../../style/team.html">
 <span class="dropdown-text">Team work</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../../style/style_guide.html">
 <span class="dropdown-text">Style Guide</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../../style/git_and_github.html">
 <span class="dropdown-text">Using Git and GitHub</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../../style/project_structure.html">
 <span class="dropdown-text">Project Structure</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../../style/data_storage.html">
 <span class="dropdown-text">Data Storage</span></a>
  </li>  
    </ul>
  </li>
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="../../../blogs/index.xml"> <i class="bi bi-rss" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction">Introduction</a></li>
  <li><a href="#data-wrangling" id="toc-data-wrangling" class="nav-link" data-scroll-target="#data-wrangling">Data wrangling</a>
  <ul class="collapse">
  <li><a href="#get-the-data" id="toc-get-the-data" class="nav-link" data-scroll-target="#get-the-data">Get the data</a></li>
  <li><a href="#determine-milestone-outcomes" id="toc-determine-milestone-outcomes" class="nav-link" data-scroll-target="#determine-milestone-outcomes">Determine milestone outcomes</a></li>
  <li><a href="#calculate-flows" id="toc-calculate-flows" class="nav-link" data-scroll-target="#calculate-flows">Calculate flows</a></li>
  </ul></li>
  <li><a href="#sankey-plot" id="toc-sankey-plot" class="nav-link" data-scroll-target="#sankey-plot">Sankey plot</a>
  <ul class="collapse">
  <li><a href="#preparing-for-plotly" id="toc-preparing-for-plotly" class="nav-link" data-scroll-target="#preparing-for-plotly">Preparing for plotly</a></li>
  <li><a href="#styling-our-sankey" id="toc-styling-our-sankey" class="nav-link" data-scroll-target="#styling-our-sankey">Styling our Sankey</a></li>
  </ul></li>
  <li><a href="#conclusion" id="toc-conclusion" class="nav-link" data-scroll-target="#conclusion">Conclusion</a></li>
  </ul>
<div class="toc-actions"><ul><li><a href="https://github.com/the-strategy-unit/data_science/edit/main/blogs/posts/2024-02-28_sankey_plot/index.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/the-strategy-unit/data_science/issues/new" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content page-columns page-full" id="quarto-document-content">


<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Visualising participant recruitment in R using Sankey plots</h1>
  <div class="quarto-categories">
    <div class="quarto-category">learning</div>
    <div class="quarto-category">tutorial</div>
    <div class="quarto-category">visualisation</div>
    <div class="quarto-category">R</div>
  </div>
  </div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Craig Parylo </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">February 28, 2024</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<section id="introduction" class="level1 page-columns page-full">
<h1>Introduction</h1>
<p>Sankey diagrams are great tools to visualise flows through a system. They show connections between the steps of a process where the width of the arrows is proportional to the flow.</p>
<p>I’m working on an evaluation of a risk screening process for people aged between 55-74 years and a history of smoking. In this Targeted Lung Health Check (TLHC) programme<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a> eligible people are invited to attend a free lung check where those assessed at high risk of lung cancer are then offered low-dose CT screening scans.</p>
<div class="no-row-height column-margin column-container"><div id="fn1"><p><sup>1</sup>&nbsp;Please visit the <a href="https://www.england.nhs.uk/contact-us/privacy-notice/how-we-use-your-information/our-services/evaluation-of-the-targeted-lung-health-check-programme/">NHS England</a> site for for more background.</p></div></div><p>We used Sankey diagrams to visualise how people have engaged with the programme, from recruitment, attendance at appointments, their outcome from risk assessment, attendance at CT scans and will eventually be extended to cover the impact of the screening on early detection of those diagnosed with lung cancer.</p>
<p>This blog post is about the technical process of preparing record-level data for visualisation in a Sankey plot using <code>R</code> and customising it to enhance look and feel. Here is how the finished product will look:</p>
<div class="cell">
<div class="cell-output-display">
<div class="plotly html-widget html-fill-item" id="htmlwidget-8d3c50b5bc54d0f0514d" style="width:672px;height:480px;"></div>
<script type="application/json" data-for="htmlwidget-8d3c50b5bc54d0f0514d">{"x":{"visdat":{"74a468a063c8":["function () ","plotlyVisDat"]},"cur_data":"74a468a063c8","attrs":{"74a468a063c8":{"orientation":"h","arrangement":"snap","node":{"label":["Eligible population","Invitation 1 No response","Invitation 1 Declined","Invitation 1 Accepted","Invitation 2 No response","Invitation 2 Accepted","Invitation 2 Declined","Invitation 3 Accepted","Invitation 3 Declined","Invitation 3 No response","Declined","Accepted","No response"],"color":["#7f8fa6","#7f8fa6","#c23616","#44bd32","#7f8fa6","#44bd32","#c23616","#44bd32","#c23616","#7f8fa6","#c23616","#44bd32","#7f8fa6"],"x":[0.001,0.22575000000000001,0.22575000000000001,0.22575000000000001,0.45050000000000001,0.45050000000000001,0.45050000000000001,0.67525000000000002,0.67525000000000002,0.67525000000000002,0.90000000000000002,0.90000000000000002,0.90000000000000002],"y":[0.53326666666666667,0.53326666666666667,0.999,0.001,0.53326666666666667,0.13406666666666667,0.90585333333333329,0.22721333333333335,0.82601333333333338,0.63972000000000007,0.93246666666666667,0.001,0.53326666666666667],"customdata":[null,"77.0%","15.0%","8.0%","46.0%","12.0%","8.0%","9.0%","10.0%","14.0%","33.0%","29.0%","38.0%"],"hovertemplate":"%{label}<br /><b>%{value}<\/b> participants<br /><b>%{customdata}<\/b> of eligible population"},"link":{"source":[0,0,0,1,1,1,2,3,1,4,4,4,5,6,4,7,8,9],"target":[2,1,3,4,5,6,10,11,12,7,8,9,11,10,12,11,10,12],"value":[15,77,8,46,12,8,15,8,11,9,10,14,12,8,13,9,10,14],"label":["15","77","8","46","12","8","15","8","11","9","10","14","12","8","13","9","10","14"],"color":["#C236164C","#7F8FA64C","#44BD324C","#7F8FA64C","#44BD324C","#C236164C","#C236164C","#44BD324C","#7F8FA64C","#44BD324C","#C236164C","#7F8FA64C","#44BD324C","#C236164C","#7F8FA64C","#44BD324C","#C236164C","#7F8FA64C"],"customdata":["15.0%","77.0%","8.0%","46.0%","12.0%","8.0%","15.0%","8.0%","11.0%","9.0%","10.0%","14.0%","12.0%","8.0%","13.0%","9.0%","10.0%","14.0%"],"hovertemplate":"%{source.label} → %{target.label}<br /><b>%{value}<\/b> participants<br /><b>%{customdata}<\/b> of eligible population"},"alpha_stroke":1,"sizes":[10,100],"spans":[1,20],"type":"sankey"}},"layout":{"margin":{"b":40,"l":60,"t":25,"r":10},"font":{"family":"Arial, Helvetica, sans-serif","size":12},"paper_bgcolor":"rgba(0,0,0,0)","hovermode":"closest","showlegend":false},"source":"A","config":{"modeBarButtonsToAdd":["hoverclosest","hovercompare"],"showSendToCloud":false,"responsive":true},"data":[{"orientation":"h","arrangement":"snap","node":{"label":["Eligible population","Invitation 1 No response","Invitation 1 Declined","Invitation 1 Accepted","Invitation 2 No response","Invitation 2 Accepted","Invitation 2 Declined","Invitation 3 Accepted","Invitation 3 Declined","Invitation 3 No response","Declined","Accepted","No response"],"color":["#7f8fa6","#7f8fa6","#c23616","#44bd32","#7f8fa6","#44bd32","#c23616","#44bd32","#c23616","#7f8fa6","#c23616","#44bd32","#7f8fa6"],"x":[0.001,0.22575000000000001,0.22575000000000001,0.22575000000000001,0.45050000000000001,0.45050000000000001,0.45050000000000001,0.67525000000000002,0.67525000000000002,0.67525000000000002,0.90000000000000002,0.90000000000000002,0.90000000000000002],"y":[0.53326666666666667,0.53326666666666667,0.999,0.001,0.53326666666666667,0.13406666666666667,0.90585333333333329,0.22721333333333335,0.82601333333333338,0.63972000000000007,0.93246666666666667,0.001,0.53326666666666667],"customdata":[null,"77.0%","15.0%","8.0%","46.0%","12.0%","8.0%","9.0%","10.0%","14.0%","33.0%","29.0%","38.0%"],"hovertemplate":"%{label}<br /><b>%{value}<\/b> participants<br /><b>%{customdata}<\/b> of eligible population"},"link":{"source":[0,0,0,1,1,1,2,3,1,4,4,4,5,6,4,7,8,9],"target":[2,1,3,4,5,6,10,11,12,7,8,9,11,10,12,11,10,12],"value":[15,77,8,46,12,8,15,8,11,9,10,14,12,8,13,9,10,14],"label":["15","77","8","46","12","8","15","8","11","9","10","14","12","8","13","9","10","14"],"color":["#C236164C","#7F8FA64C","#44BD324C","#7F8FA64C","#44BD324C","#C236164C","#C236164C","#44BD324C","#7F8FA64C","#44BD324C","#C236164C","#7F8FA64C","#44BD324C","#C236164C","#7F8FA64C","#44BD324C","#C236164C","#7F8FA64C"],"customdata":["15.0%","77.0%","8.0%","46.0%","12.0%","8.0%","15.0%","8.0%","11.0%","9.0%","10.0%","14.0%","12.0%","8.0%","13.0%","9.0%","10.0%","14.0%"],"hovertemplate":"%{source.label} → %{target.label}<br /><b>%{value}<\/b> participants<br /><b>%{customdata}<\/b> of eligible population"},"type":"sankey","frame":null}],"highlight":{"on":"plotly_click","persistent":false,"dynamic":false,"selectize":false,"opacityDim":0.20000000000000001,"selected":{"opacity":1},"debounce":0},"shinyEvents":["plotly_hover","plotly_click","plotly_selected","plotly_relayout","plotly_brushed","plotly_brushing","plotly_clickannotation","plotly_doubleclick","plotly_deselect","plotly_afterplot","plotly_sunburstclick"],"base_url":"https://plot.ly"},"evals":[],"jsHooks":[]}</script>
</div>
</div>
</section>
<section id="data-wrangling" class="level1 page-columns page-full">
<h1>Data wrangling</h1>
<p>First we’ll attach some packages. I’ll be using <a href="https://plotly.com/r/sankey-diagram/">plotly</a> for the visualisation of the Sankey chart, <a href="https://tidygraph.data-imaginist.com/">tidygraph</a> for graph manipulation and <a href="https://scales.r-lib.org/">scales</a> to handle colour transformation and rescaling values. We will also be using the <a href="https://www.tidyverse.org/">tidyverse</a> and <a href="https://glue.tidyverse.org/">glue</a> packages for general data wrangling and <a href="https://glin.github.io/reactable/index.html">reactable</a> to preview our data as we go along.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># libraries</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse) <span class="co"># 'tidy' data wrangling</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(plotly) <span class="co"># sankey visualisation framework</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(reactable) <span class="co"># viewing interactive datatables</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(glue) <span class="co"># concatenating strings</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidygraph) <span class="co"># api for graph / network manipulation</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(scales) <span class="co"># used for colour transformation</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<section id="get-the-data" class="level2">
<h2 class="anchored" data-anchor-id="get-the-data">Get the data</h2>
<p>In this example we will work with a simplified set of data focused on invitations.</p>
<p>The invites table holds details of when people were sent a letter or message inviting them to take part, how many times they were invited and how the person responded.</p>
<p>The people eligible for the programme are identified up-front and are represented by a unique ID with one row per person. Let’s assume each person receives at least one invitation to take part, they can have one of three outcomes:</p>
<ol type="1">
<li><p>They accept the invitation and agree to take part,</p></li>
<li><p>They decline the invitation,</p></li>
<li><p>They do not respond to the invitation.</p></li>
</ol>
<p>If the person doesn’t respond to the first invitation they may be sent a second invitation and could be offered a third invitation if they didn’t respond to the second.</p>
<p>Here is the specification for our simplified invites table:</p>
<table class="caption-top table">
<caption>Invites specification</caption>
<colgroup>
<col style="width: 14%">
<col style="width: 8%">
<col style="width: 75%">
</colgroup>
<thead>
<tr class="header">
<th>Field</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Participant ID</td>
<td>Integer</td>
<td>A unique identifier for each person.</td>
</tr>
<tr class="even">
<td>Invite date 1</td>
<td>Date</td>
<td><p>The date the person was first invited to participate.</p>
<p>Every person will have a date in this field.</p></td>
</tr>
<tr class="odd">
<td>Invite date 2</td>
<td>Date</td>
<td>The date a second invitation was sent.</td>
</tr>
<tr class="even">
<td>Invite date 3</td>
<td>Date</td>
<td>The date a third invitation was sent.</td>
</tr>
<tr class="odd">
<td>Invite outcome</td>
<td>Text</td>
<td>The outcome from the invite, one of either ‘Accepted’, ‘Declined’ or ‘No response’.</td>
</tr>
</tbody>
</table>
<p>Everyone receives at least one invite. Assuming a third of these respond (to either accept or decline) then two-thirds receive a follow-up invite. Of these, we assume half respond, meaning the remaining participants receive a third invite.</p>
<p>Here we generate 100 rows of example data to populate our table.</p>
<div class="cell fig-cap-location-top">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2" data-cap-location="top"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># set a randomisation seed for reproducibility</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="at">seed =</span> <span class="dv">1234</span>)</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="co"># define some parameters</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>start_date <span class="ot">&lt;-</span> <span class="fu">as.Date</span>(<span class="st">"2019-01-01"</span>)</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>end_date <span class="ot">&lt;-</span> <span class="fu">as.Date</span>(<span class="st">"2021-01-01"</span>)</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>rows <span class="ot">&lt;-</span> <span class="dv">100</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>df_invites_1 <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>  <span class="co"># create a unique id for each participant</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">participant_id =</span> <span class="dv">1</span><span class="sc">:</span>rows,</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>  <span class="co"># create a random initial invite date between our start and end dates</span></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">invite_1_date =</span> <span class="fu">sample</span>(</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">seq</span>(start_date, end_date, <span class="at">by =</span> <span class="st">"day"</span>),</span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">size =</span> rows, <span class="at">replace =</span> T</span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>  <span class="co"># create a random outcome for this participant</span></span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>  <span class="at">invite_outcome =</span> <span class="fu">sample</span>(</span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="fu">c</span>(<span class="st">"Accepted"</span>, <span class="st">"Declined"</span>, <span class="st">"No response"</span>),</span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">size =</span> rows, <span class="at">replace =</span> T</span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a><span class="co"># take a sample of participants and allocate them a second invite date</span></span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a>df_invites_2 <span class="ot">&lt;-</span> df_invites_1 <span class="sc">|&gt;</span></span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a>  <span class="co"># sample two thirds of participants to get a second invite</span></span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice_sample</span>(<span class="at">prop =</span> <span class="dv">2</span> <span class="sc">/</span> <span class="dv">3</span>) <span class="sc">|&gt;</span></span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a>  <span class="co"># allocate a date between 10 and 30 days following the first</span></span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true" tabindex="-1"></a>    <span class="at">invite_2_date =</span> invite_1_date <span class="sc">+</span> <span class="fu">sample</span>(<span class="dv">10</span><span class="sc">:</span><span class="dv">30</span>, <span class="at">size =</span> <span class="fu">n</span>(), <span class="at">replace =</span> T)</span>
<span id="cb2-33"><a href="#cb2-33" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb2-34"><a href="#cb2-34" aria-hidden="true" tabindex="-1"></a>  <span class="co"># keep just id and second date</span></span>
<span id="cb2-35"><a href="#cb2-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(participant_id, invite_2_date)</span>
<span id="cb2-36"><a href="#cb2-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-37"><a href="#cb2-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-38"><a href="#cb2-38" aria-hidden="true" tabindex="-1"></a><span class="co"># take a sample of those with a second invite and allocate them a third invite date</span></span>
<span id="cb2-39"><a href="#cb2-39" aria-hidden="true" tabindex="-1"></a>df_invites_3 <span class="ot">&lt;-</span> df_invites_2 <span class="sc">|&gt;</span></span>
<span id="cb2-40"><a href="#cb2-40" aria-hidden="true" tabindex="-1"></a>  <span class="co"># sample half of these to get a third invite</span></span>
<span id="cb2-41"><a href="#cb2-41" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice_sample</span>(<span class="at">prop =</span> <span class="dv">1</span> <span class="sc">/</span> <span class="dv">2</span>) <span class="sc">|&gt;</span></span>
<span id="cb2-42"><a href="#cb2-42" aria-hidden="true" tabindex="-1"></a>  <span class="co"># allocate a date between 10 to 30 days following the second</span></span>
<span id="cb2-43"><a href="#cb2-43" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb2-44"><a href="#cb2-44" aria-hidden="true" tabindex="-1"></a>    <span class="at">invite_3_date =</span> invite_2_date <span class="sc">+</span> <span class="fu">sample</span>(<span class="dv">10</span><span class="sc">:</span><span class="dv">30</span>, <span class="at">size =</span> <span class="fu">n</span>(), <span class="at">replace =</span> T)</span>
<span id="cb2-45"><a href="#cb2-45" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb2-46"><a href="#cb2-46" aria-hidden="true" tabindex="-1"></a>  <span class="co"># keep just id and second date</span></span>
<span id="cb2-47"><a href="#cb2-47" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(participant_id, invite_3_date)</span>
<span id="cb2-48"><a href="#cb2-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-49"><a href="#cb2-49" aria-hidden="true" tabindex="-1"></a><span class="co"># combine the 2nd and 3rd invites with the first table</span></span>
<span id="cb2-50"><a href="#cb2-50" aria-hidden="true" tabindex="-1"></a>df_invites <span class="ot">&lt;-</span> df_invites_1 <span class="sc">|&gt;</span></span>
<span id="cb2-51"><a href="#cb2-51" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(</span>
<span id="cb2-52"><a href="#cb2-52" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> df_invites_2,</span>
<span id="cb2-53"><a href="#cb2-53" aria-hidden="true" tabindex="-1"></a>    <span class="at">by =</span> <span class="st">"participant_id"</span></span>
<span id="cb2-54"><a href="#cb2-54" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb2-55"><a href="#cb2-55" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(</span>
<span id="cb2-56"><a href="#cb2-56" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> df_invites_3,</span>
<span id="cb2-57"><a href="#cb2-57" aria-hidden="true" tabindex="-1"></a>    <span class="at">by =</span> <span class="st">"participant_id"</span></span>
<span id="cb2-58"><a href="#cb2-58" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb2-59"><a href="#cb2-59" aria-hidden="true" tabindex="-1"></a>  <span class="co"># move the outcome field after the third invite</span></span>
<span id="cb2-60"><a href="#cb2-60" aria-hidden="true" tabindex="-1"></a>  <span class="fu">relocate</span>(invite_outcome, <span class="at">.after =</span> invite_3_date)</span>
<span id="cb2-61"><a href="#cb2-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-62"><a href="#cb2-62" aria-hidden="true" tabindex="-1"></a><span class="co"># housekeeping</span></span>
<span id="cb2-63"><a href="#cb2-63" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(df_invites_1, df_invites_2, df_invites_3, start_date, end_date, rows)</span>
<span id="cb2-64"><a href="#cb2-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-65"><a href="#cb2-65" aria-hidden="true" tabindex="-1"></a><span class="co"># view our data</span></span>
<span id="cb2-66"><a href="#cb2-66" aria-hidden="true" tabindex="-1"></a>df_invites <span class="sc">|&gt;</span></span>
<span id="cb2-67"><a href="#cb2-67" aria-hidden="true" tabindex="-1"></a>  <span class="fu">reactable</span>(<span class="at">defaultPageSize =</span> <span class="dv">5</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<div class="reactable html-widget html-fill-item" id="htmlwidget-58b100ebed7fb947b986" style="width:auto;height:auto;"></div>
<script type="application/json" data-for="htmlwidget-58b100ebed7fb947b986">{"x":{"tag":{"name":"Reactable","attribs":{"data":{"participant_id":[1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100],"invite_1_date":["2019-10-11","2019-04-11","2020-09-14","2020-10-06","2020-02-04","2019-04-08","2019-04-13","2020-12-26","2020-08-24","2019-11-22","2019-03-20","2019-09-27","2020-01-17","2019-07-03","2020-07-27","2019-01-04","2020-10-22","2020-07-05","2019-07-31","2019-07-14","2020-05-25","2020-04-23","2020-08-27","2020-09-25","2020-07-31","2020-05-24","2020-11-17","2020-02-28","2020-01-14","2019-04-18","2019-05-11","2019-12-09","2019-02-10","2020-09-18","2019-10-25","2019-09-15","2020-09-20","2019-03-20","2019-07-01","2019-11-01","2019-12-24","2020-11-26","2019-11-03","2019-11-01","2019-08-09","2020-07-14","2019-11-09","2019-05-16","2019-05-25","2019-05-03","2019-08-22","2020-08-30","2020-05-09","2020-06-17","2019-10-24","2019-07-27","2019-05-11","2020-07-22","2020-06-05","2019-09-05","2019-12-31","2020-10-26","2020-10-04","2020-08-17","2020-03-09","2019-08-06","2020-12-27","2020-05-22","2019-10-03","2019-06-18","2019-03-12","2020-07-26","2019-11-22","2020-04-29","2020-10-28","2020-04-04","2019-03-01","2020-03-24","2020-07-01","2019-01-19","2020-10-10","2020-09-29","2020-10-31","2019-11-15","2019-04-26","2019-05-25","2019-04-12","2019-08-02","2020-01-25","2020-08-19","2020-08-19","2019-06-09","2019-03-18","2020-06-12","2019-05-06","2019-09-19","2020-03-17","2020-10-03","2019-06-30","2019-06-12"],"invite_2_date":[null,"2019-04-26","2020-10-03",null,"2020-03-05",null,null,null,"2020-09-13","2019-12-14","2019-04-13","2019-10-10","2020-02-04","2019-07-27","2020-08-09",null,null,null,null,"2019-08-10","2020-06-17","2020-05-21","2020-09-10","2020-10-12","2020-08-23",null,"2020-12-16",null,"2020-02-12","2019-04-29","2019-05-26","2020-01-04","2019-03-10","2020-10-11",null,"2019-09-28","2020-09-30","2019-04-17",null,null,"2020-01-18",null,"2019-11-28","2019-11-14","2019-08-28","2020-08-10","2019-12-07","2019-05-26",null,"2019-05-29","2019-09-10","2020-09-23","2020-05-21",null,"2019-11-15",null,"2019-06-06","2020-08-07","2020-06-16","2019-09-29","2020-01-13",null,null,null,"2020-03-28","2019-09-05","2021-01-21",null,"2019-10-18","2019-07-10",null,null,"2019-12-18","2020-05-23","2020-11-24","2020-04-26","2019-03-11","2020-04-16","2020-07-22",null,"2020-11-09","2020-10-29","2020-11-28",null,null,null,"2019-05-04",null,"2020-02-12","2020-09-07","2020-09-11",null,null,"2020-07-06",null,null,null,"2020-10-20","2019-07-22","2019-07-01"],"invite_3_date":[null,"2019-05-24","2020-10-16",null,"2020-04-01",null,null,null,"2020-10-01","2020-01-13","2019-05-05",null,null,"2019-08-12",null,null,null,null,null,"2019-09-06","2020-07-04","2020-06-14","2020-09-22","2020-11-11","2020-09-18",null,null,null,null,null,null,null,null,null,null,null,null,"2019-05-02",null,null,null,null,"2019-12-09","2019-12-04","2019-09-22",null,null,null,null,null,"2019-09-23",null,null,null,"2019-12-09",null,"2019-06-30",null,"2020-07-16","2019-10-10",null,null,null,null,null,"2019-09-29",null,null,null,null,null,null,"2019-12-31",null,null,null,"2019-03-27","2020-05-12","2020-08-03",null,"2020-11-29",null,"2020-12-22",null,null,null,null,null,"2020-03-12",null,"2020-09-28",null,null,"2020-08-04",null,null,null,"2020-11-10",null,null],"invite_outcome":["Declined","Accepted","Declined","Declined","Declined","Accepted","No response","No response","Accepted","Declined","Declined","Accepted","Accepted","Accepted","Accepted","Declined","Declined","Declined","No response","Declined","Declined","No response","No response","No response","Accepted","Declined","Declined","No response","No response","No response","No response","Accepted","No response","No response","No response","Declined","Declined","No response","Declined","Accepted","Accepted","Accepted","No response","No response","No response","Accepted","Accepted","No response","Declined","No response","Accepted","Accepted","No response","Declined","Accepted","No response","No response","Declined","Declined","Declined","Accepted","Accepted","No response","Accepted","Accepted","Accepted","Accepted","No response","No response","Declined","Accepted","Declined","Declined","Declined","No response","Declined","No response","No response","No response","Declined","No response","No response","Accepted","No response","Accepted","No response","No response","Declined","No response","No response","Declined","Declined","No response","Accepted","Declined","Declined","Accepted","No response","Declined","Accepted"]},"columns":[{"id":"participant_id","name":"participant_id","type":"numeric"},{"id":"invite_1_date","name":"invite_1_date","type":"Date"},{"id":"invite_2_date","name":"invite_2_date","type":"Date"},{"id":"invite_3_date","name":"invite_3_date","type":"Date"},{"id":"invite_outcome","name":"invite_outcome","type":"character"}],"defaultPageSize":5,"dataKey":"812760e5c2269ef93c4668c581c72808"},"children":[]},"class":"reactR_markup"},"evals":[],"jsHooks":[]}</script>
<p>Generated invite table</p>
</div>
</div>
</section>
<section id="determine-milestone-outcomes" class="level2">
<h2 class="anchored" data-anchor-id="determine-milestone-outcomes">Determine milestone outcomes</h2>
<p>The next step is to take our source table and convert the data into a series of milestones (and associated outcomes) that represents how our invited participants moved through the pathway.</p>
<p>In our example we have five milestones to represent in our Sankey plot:</p>
<ul>
<li><p>Our eligible population (everyone in our invites table),</p></li>
<li><p>The result from the first invitation,</p></li>
<li><p>The result from the second invitation,</p></li>
<li><p>The result from the third invitation,</p></li>
<li><p>The overall invite outcome.</p></li>
</ul>
<p>Aside from the eligible population, where everyone starts with the same value, participants will have one of several outcomes at each milestone. This step is about naming these milestones and the outcomes.</p>
<p>It is important that each milestone-outcome has unique values. An outcome of ‘No response’ can be recorded against the first, second and third invite, and we wish to see these outcomes separately represented on the Sankey (rather than just one ‘No response’), so each outcome must be made unique. In this example we prefix the outcome from each invite with the number of the invite, e.g.&nbsp;‘Invite 1 No response’.</p>
<p>The reason for this will become clearer when we come to plot the Sankey, but for now we produce these milestone-outcomes from our invites table.</p>
<div class="cell fig-cap-location-top">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb3" data-cap-location="top"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>df_milestones <span class="ot">&lt;-</span> df_invites <span class="sc">|&gt;</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>    <span class="co"># everyone starts in the eligible population</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">start_population =</span> <span class="st">"Eligible population"</span>,</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># work out what happened following the first invite</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">invite_1_outcome =</span> <span class="fu">case_when</span>(</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>      <span class="co"># if a second invite was sent we assume there was no outcome from the first</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>      <span class="sc">!</span><span class="fu">is.na</span>(invite_2_date) <span class="sc">~</span> <span class="st">"Invitation 1 No response"</span>,</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>      <span class="co"># otherwise the overall outcome resulted from the first invite</span></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>      <span class="at">.default =</span> <span class="fu">glue</span>(<span class="st">"Invitation 1 {invite_outcome}"</span>)</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># work out what happened following the second invite</span></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">invite_2_outcome =</span> <span class="fu">case_when</span>(</span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>      <span class="co"># if a third invite was sent we assume there was no outcome from the second</span></span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>      <span class="sc">!</span><span class="fu">is.na</span>(invite_3_date) <span class="sc">~</span> <span class="st">"Invitation 2 No response"</span>,</span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>      <span class="co"># if a second invite was sent but no third then</span></span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>      <span class="sc">!</span><span class="fu">is.na</span>(invite_2_date) <span class="sc">~</span> <span class="fu">glue</span>(<span class="st">"Invitation 2 {invite_outcome}"</span>),</span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>      <span class="co"># default to NA if neither of the above are true</span></span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a>      <span class="at">.default =</span> <span class="cn">NA</span></span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a>    <span class="co"># work out what happened following the third invite</span></span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a>    <span class="at">invite_3_outcome =</span> <span class="fu">case_when</span>(</span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a>      <span class="co"># if a third invite was sent then the outcome is the overall outcome</span></span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a>      <span class="sc">!</span><span class="fu">is.na</span>(invite_3_date) <span class="sc">~</span> <span class="fu">glue</span>(<span class="st">"Invitation 3 {invite_outcome}"</span>),</span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a>      <span class="co"># otherwise mark as NA</span></span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a>      <span class="at">.default =</span> <span class="cn">NA</span></span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb3-32"><a href="#cb3-32" aria-hidden="true" tabindex="-1"></a>  <span class="co"># exclude the dates as they are no longer needed</span></span>
<span id="cb3-33"><a href="#cb3-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span><span class="fu">contains</span>(<span class="st">"_date"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb3-34"><a href="#cb3-34" aria-hidden="true" tabindex="-1"></a>  <span class="co"># move the overall invite outcome to the end</span></span>
<span id="cb3-35"><a href="#cb3-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">relocate</span>(invite_outcome, <span class="at">.after =</span> invite_3_outcome)</span>
<span id="cb3-36"><a href="#cb3-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-37"><a href="#cb3-37" aria-hidden="true" tabindex="-1"></a><span class="co"># view our data</span></span>
<span id="cb3-38"><a href="#cb3-38" aria-hidden="true" tabindex="-1"></a>df_milestones <span class="sc">|&gt;</span></span>
<span id="cb3-39"><a href="#cb3-39" aria-hidden="true" tabindex="-1"></a>  <span class="fu">reactable</span>(<span class="at">defaultPageSize =</span> <span class="dv">5</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<div class="reactable html-widget html-fill-item" id="htmlwidget-286350ed2b9015d71ef1" style="width:auto;height:auto;"></div>
<script type="application/json" data-for="htmlwidget-286350ed2b9015d71ef1">{"x":{"tag":{"name":"Reactable","attribs":{"data":{"participant_id":[1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100],"start_population":["Eligible population","Eligible population","Eligible population","Eligible population","Eligible population","Eligible population","Eligible population","Eligible population","Eligible population","Eligible population","Eligible population","Eligible population","Eligible population","Eligible population","Eligible population","Eligible population","Eligible population","Eligible population","Eligible population","Eligible population","Eligible population","Eligible population","Eligible population","Eligible population","Eligible population","Eligible population","Eligible population","Eligible population","Eligible population","Eligible population","Eligible population","Eligible population","Eligible population","Eligible population","Eligible population","Eligible population","Eligible population","Eligible population","Eligible population","Eligible population","Eligible population","Eligible population","Eligible population","Eligible population","Eligible population","Eligible population","Eligible population","Eligible population","Eligible population","Eligible population","Eligible population","Eligible population","Eligible population","Eligible population","Eligible population","Eligible population","Eligible population","Eligible population","Eligible population","Eligible population","Eligible population","Eligible population","Eligible population","Eligible population","Eligible population","Eligible population","Eligible population","Eligible population","Eligible population","Eligible population","Eligible population","Eligible population","Eligible population","Eligible population","Eligible population","Eligible population","Eligible population","Eligible population","Eligible population","Eligible population","Eligible population","Eligible population","Eligible population","Eligible population","Eligible population","Eligible population","Eligible population","Eligible population","Eligible population","Eligible population","Eligible population","Eligible population","Eligible population","Eligible population","Eligible population","Eligible population","Eligible population","Eligible population","Eligible population","Eligible population"],"invite_1_outcome":["Invitation 1 Declined","Invitation 1 No response","Invitation 1 No response","Invitation 1 Declined","Invitation 1 No response","Invitation 1 Accepted","Invitation 1 No response","Invitation 1 No response","Invitation 1 No response","Invitation 1 No response","Invitation 1 No response","Invitation 1 No response","Invitation 1 No response","Invitation 1 No response","Invitation 1 No response","Invitation 1 Declined","Invitation 1 Declined","Invitation 1 Declined","Invitation 1 No response","Invitation 1 No response","Invitation 1 No response","Invitation 1 No response","Invitation 1 No response","Invitation 1 No response","Invitation 1 No response","Invitation 1 Declined","Invitation 1 No response","Invitation 1 No response","Invitation 1 No response","Invitation 1 No response","Invitation 1 No response","Invitation 1 No response","Invitation 1 No response","Invitation 1 No response","Invitation 1 No response","Invitation 1 No response","Invitation 1 No response","Invitation 1 No response","Invitation 1 Declined","Invitation 1 Accepted","Invitation 1 No response","Invitation 1 Accepted","Invitation 1 No response","Invitation 1 No response","Invitation 1 No response","Invitation 1 No response","Invitation 1 No response","Invitation 1 No response","Invitation 1 Declined","Invitation 1 No response","Invitation 1 No response","Invitation 1 No response","Invitation 1 No response","Invitation 1 Declined","Invitation 1 No response","Invitation 1 No response","Invitation 1 No response","Invitation 1 No response","Invitation 1 No response","Invitation 1 No response","Invitation 1 No response","Invitation 1 Accepted","Invitation 1 No response","Invitation 1 Accepted","Invitation 1 No response","Invitation 1 No response","Invitation 1 No response","Invitation 1 No response","Invitation 1 No response","Invitation 1 No response","Invitation 1 Accepted","Invitation 1 Declined","Invitation 1 No response","Invitation 1 No response","Invitation 1 No response","Invitation 1 No response","Invitation 1 No response","Invitation 1 No response","Invitation 1 No response","Invitation 1 Declined","Invitation 1 No response","Invitation 1 No response","Invitation 1 No response","Invitation 1 No response","Invitation 1 Accepted","Invitation 1 No response","Invitation 1 No response","Invitation 1 Declined","Invitation 1 No response","Invitation 1 No response","Invitation 1 No response","Invitation 1 Declined","Invitation 1 No response","Invitation 1 No response","Invitation 1 Declined","Invitation 1 Declined","Invitation 1 Accepted","Invitation 1 No response","Invitation 1 No response","Invitation 1 No response"],"invite_2_outcome":[null,"Invitation 2 No response","Invitation 2 No response",null,"Invitation 2 No response",null,null,null,"Invitation 2 No response","Invitation 2 No response","Invitation 2 No response","Invitation 2 Accepted","Invitation 2 Accepted","Invitation 2 No response","Invitation 2 Accepted",null,null,null,null,"Invitation 2 No response","Invitation 2 No response","Invitation 2 No response","Invitation 2 No response","Invitation 2 No response","Invitation 2 No response",null,"Invitation 2 Declined",null,"Invitation 2 No response","Invitation 2 No response","Invitation 2 No response","Invitation 2 Accepted","Invitation 2 No response","Invitation 2 No response",null,"Invitation 2 Declined","Invitation 2 Declined","Invitation 2 No response",null,null,"Invitation 2 Accepted",null,"Invitation 2 No response","Invitation 2 No response","Invitation 2 No response","Invitation 2 Accepted","Invitation 2 Accepted","Invitation 2 No response",null,"Invitation 2 No response","Invitation 2 No response","Invitation 2 Accepted","Invitation 2 No response",null,"Invitation 2 No response",null,"Invitation 2 No response","Invitation 2 Declined","Invitation 2 No response","Invitation 2 No response","Invitation 2 Accepted",null,null,null,"Invitation 2 Accepted","Invitation 2 No response","Invitation 2 Accepted",null,"Invitation 2 No response","Invitation 2 Declined",null,null,"Invitation 2 No response","Invitation 2 Declined","Invitation 2 No response","Invitation 2 Declined","Invitation 2 No response","Invitation 2 No response","Invitation 2 No response",null,"Invitation 2 No response","Invitation 2 No response","Invitation 2 No response",null,null,null,"Invitation 2 No response",null,"Invitation 2 No response","Invitation 2 No response","Invitation 2 No response",null,null,"Invitation 2 No response",null,null,null,"Invitation 2 No response","Invitation 2 Declined","Invitation 2 Accepted"],"invite_3_outcome":[null,"Invitation 3 Accepted","Invitation 3 Declined",null,"Invitation 3 Declined",null,null,null,"Invitation 3 Accepted","Invitation 3 Declined","Invitation 3 Declined",null,null,"Invitation 3 Accepted",null,null,null,null,null,"Invitation 3 Declined","Invitation 3 Declined","Invitation 3 No response","Invitation 3 No response","Invitation 3 No response","Invitation 3 Accepted",null,null,null,null,null,null,null,null,null,null,null,null,"Invitation 3 No response",null,null,null,null,"Invitation 3 No response","Invitation 3 No response","Invitation 3 No response",null,null,null,null,null,"Invitation 3 Accepted",null,null,null,"Invitation 3 Accepted",null,"Invitation 3 No response",null,"Invitation 3 Declined","Invitation 3 Declined",null,null,null,null,null,"Invitation 3 Accepted",null,null,null,null,null,null,"Invitation 3 Declined",null,null,null,"Invitation 3 No response","Invitation 3 No response","Invitation 3 No response",null,"Invitation 3 No response",null,"Invitation 3 Accepted",null,null,null,null,null,"Invitation 3 No response",null,"Invitation 3 Declined",null,null,"Invitation 3 Accepted",null,null,null,"Invitation 3 No response",null,null],"invite_outcome":["Declined","Accepted","Declined","Declined","Declined","Accepted","No response","No response","Accepted","Declined","Declined","Accepted","Accepted","Accepted","Accepted","Declined","Declined","Declined","No response","Declined","Declined","No response","No response","No response","Accepted","Declined","Declined","No response","No response","No response","No response","Accepted","No response","No response","No response","Declined","Declined","No response","Declined","Accepted","Accepted","Accepted","No response","No response","No response","Accepted","Accepted","No response","Declined","No response","Accepted","Accepted","No response","Declined","Accepted","No response","No response","Declined","Declined","Declined","Accepted","Accepted","No response","Accepted","Accepted","Accepted","Accepted","No response","No response","Declined","Accepted","Declined","Declined","Declined","No response","Declined","No response","No response","No response","Declined","No response","No response","Accepted","No response","Accepted","No response","No response","Declined","No response","No response","Declined","Declined","No response","Accepted","Declined","Declined","Accepted","No response","Declined","Accepted"]},"columns":[{"id":"participant_id","name":"participant_id","type":"numeric"},{"id":"start_population","name":"start_population","type":"character"},{"id":"invite_1_outcome","name":"invite_1_outcome","type":["glue","character"]},{"id":"invite_2_outcome","name":"invite_2_outcome","type":["glue","character"]},{"id":"invite_3_outcome","name":"invite_3_outcome","type":["glue","character"]},{"id":"invite_outcome","name":"invite_outcome","type":"character"}],"defaultPageSize":5,"dataKey":"a450da1debd7915b64a9b7311b7f1d33"},"children":[]},"class":"reactR_markup"},"evals":[],"jsHooks":[]}</script>
<p>Milestone-outcomes for participants</p>
</div>
</div>
</section>
<section id="calculate-flows" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="calculate-flows">Calculate flows</h2>
<p>Next we take pairs of milestone-outcomes and calculate the number of participants that moved between them.</p>
<p>Here we utilise the power of <code>dplyr::summarise</code> with an argument <code>.by</code> to group by our data before counting the number of unique participants who move between our start and end groups.</p>
<p>For invites 2 and 3 we perform two sets of summaries:</p>
<ol type="1">
<li><p>The first where the values in the <code>to</code> and <code>from</code> fields contain details.</p></li>
<li><p>The second to capture cases where the <code>to</code> destination is NULL. This is because the participant responded at the previous invite so there was no subsequent invite. In these cases we flow the participant to the overall invite outcome.<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a></p></li>
</ol>
<div class="no-row-height column-margin column-container"><div id="fn2"><p><sup>2</sup>&nbsp;If you are thinking there is a lot of repetition here, you’re right. In practice I abstracted both steps to a function and passed in the parameters for the <code>from</code> and <code>to</code> variables and simplified my workflow a little, however, I’m showing it in plain form here for simplification.</p></div></div><div class="cell fig-cap-location-top">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb4" data-cap-location="top"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>df_flows <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># flow from population to invite 1</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>  df_milestones <span class="sc">|&gt;</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(start_population) <span class="sc">&amp;</span> <span class="sc">!</span><span class="fu">is.na</span>(invite_1_outcome)) <span class="sc">|&gt;</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rename</span>(<span class="at">from =</span> start_population, <span class="at">to =</span> invite_1_outcome) <span class="sc">|&gt;</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarise</span>(</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>      <span class="at">flow =</span> <span class="fu">n_distinct</span>(participant_id, <span class="at">na.rm =</span> T),</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>      <span class="at">.by =</span> <span class="fu">c</span>(from, to)</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>  <span class="co"># flow from invite 1 to invite 2 (where not NA)</span></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>  df_milestones <span class="sc">|&gt;</span></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(invite_1_outcome) <span class="sc">&amp;</span> <span class="sc">!</span><span class="fu">is.na</span>(invite_2_outcome)) <span class="sc">|&gt;</span></span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rename</span>(<span class="at">from =</span> invite_1_outcome, <span class="at">to =</span> invite_2_outcome) <span class="sc">|&gt;</span></span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarise</span>(</span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>      <span class="at">flow =</span> <span class="fu">n_distinct</span>(participant_id, <span class="at">na.rm =</span> T),</span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>      <span class="at">.by =</span> <span class="fu">c</span>(from, to)</span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>  <span class="co"># flow from invite 1 to overall invite outcome (where invite 2 is NA)</span></span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a>  df_milestones <span class="sc">|&gt;</span></span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(invite_1_outcome) <span class="sc">&amp;</span> <span class="fu">is.na</span>(invite_2_outcome)) <span class="sc">|&gt;</span></span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rename</span>(<span class="at">from =</span> invite_1_outcome, <span class="at">to =</span> invite_outcome) <span class="sc">|&gt;</span></span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarise</span>(</span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a>      <span class="at">flow =</span> <span class="fu">n_distinct</span>(participant_id, <span class="at">na.rm =</span> T),</span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a>      <span class="at">.by =</span> <span class="fu">c</span>(from, to)</span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true" tabindex="-1"></a>  <span class="co"># flow from invite 2 to invite 3 (where not NA)</span></span>
<span id="cb4-31"><a href="#cb4-31" aria-hidden="true" tabindex="-1"></a>  df_milestones <span class="sc">|&gt;</span></span>
<span id="cb4-32"><a href="#cb4-32" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(invite_2_outcome) <span class="sc">&amp;</span> <span class="sc">!</span><span class="fu">is.na</span>(invite_3_outcome)) <span class="sc">|&gt;</span></span>
<span id="cb4-33"><a href="#cb4-33" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rename</span>(<span class="at">from =</span> invite_2_outcome, <span class="at">to =</span> invite_3_outcome) <span class="sc">|&gt;</span></span>
<span id="cb4-34"><a href="#cb4-34" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarise</span>(</span>
<span id="cb4-35"><a href="#cb4-35" aria-hidden="true" tabindex="-1"></a>      <span class="at">flow =</span> <span class="fu">n_distinct</span>(participant_id, <span class="at">na.rm =</span> T),</span>
<span id="cb4-36"><a href="#cb4-36" aria-hidden="true" tabindex="-1"></a>      <span class="at">.by =</span> <span class="fu">c</span>(from, to)</span>
<span id="cb4-37"><a href="#cb4-37" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb4-38"><a href="#cb4-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-39"><a href="#cb4-39" aria-hidden="true" tabindex="-1"></a>  <span class="co"># flow from invite 2 to overall invite outcome (where invite 3 is NA)</span></span>
<span id="cb4-40"><a href="#cb4-40" aria-hidden="true" tabindex="-1"></a>  df_milestones <span class="sc">|&gt;</span></span>
<span id="cb4-41"><a href="#cb4-41" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(invite_2_outcome) <span class="sc">&amp;</span> <span class="fu">is.na</span>(invite_3_outcome)) <span class="sc">|&gt;</span></span>
<span id="cb4-42"><a href="#cb4-42" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rename</span>(<span class="at">from =</span> invite_2_outcome, <span class="at">to =</span> invite_outcome) <span class="sc">|&gt;</span></span>
<span id="cb4-43"><a href="#cb4-43" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarise</span>(</span>
<span id="cb4-44"><a href="#cb4-44" aria-hidden="true" tabindex="-1"></a>      <span class="at">flow =</span> <span class="fu">n_distinct</span>(participant_id, <span class="at">na.rm =</span> T),</span>
<span id="cb4-45"><a href="#cb4-45" aria-hidden="true" tabindex="-1"></a>      <span class="at">.by =</span> <span class="fu">c</span>(from, to)</span>
<span id="cb4-46"><a href="#cb4-46" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb4-47"><a href="#cb4-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-48"><a href="#cb4-48" aria-hidden="true" tabindex="-1"></a>  <span class="co"># final flow - invite 3 to overall outcome (where both are not NA)</span></span>
<span id="cb4-49"><a href="#cb4-49" aria-hidden="true" tabindex="-1"></a>  df_milestones <span class="sc">|&gt;</span></span>
<span id="cb4-50"><a href="#cb4-50" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(invite_3_outcome) <span class="sc">&amp;</span> <span class="sc">!</span><span class="fu">is.na</span>(invite_outcome)) <span class="sc">|&gt;</span></span>
<span id="cb4-51"><a href="#cb4-51" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rename</span>(<span class="at">from =</span> invite_3_outcome, <span class="at">to =</span> invite_outcome) <span class="sc">|&gt;</span></span>
<span id="cb4-52"><a href="#cb4-52" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarise</span>(</span>
<span id="cb4-53"><a href="#cb4-53" aria-hidden="true" tabindex="-1"></a>      <span class="at">flow =</span> <span class="fu">n_distinct</span>(participant_id, <span class="at">na.rm =</span> T),</span>
<span id="cb4-54"><a href="#cb4-54" aria-hidden="true" tabindex="-1"></a>      <span class="at">.by =</span> <span class="fu">c</span>(from, to)</span>
<span id="cb4-55"><a href="#cb4-55" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb4-56"><a href="#cb4-56" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb4-57"><a href="#cb4-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-58"><a href="#cb4-58" aria-hidden="true" tabindex="-1"></a><span class="co"># view our data</span></span>
<span id="cb4-59"><a href="#cb4-59" aria-hidden="true" tabindex="-1"></a>df_flows <span class="sc">|&gt;</span></span>
<span id="cb4-60"><a href="#cb4-60" aria-hidden="true" tabindex="-1"></a>  <span class="fu">reactable</span>(<span class="at">defaultPageSize =</span> <span class="dv">5</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<div class="reactable html-widget html-fill-item" id="htmlwidget-71d01034894540eb0211" style="width:auto;height:auto;"></div>
<script type="application/json" data-for="htmlwidget-71d01034894540eb0211">{"x":{"tag":{"name":"Reactable","attribs":{"data":{"from":["Eligible population","Eligible population","Eligible population","Invitation 1 No response","Invitation 1 No response","Invitation 1 No response","Invitation 1 Declined","Invitation 1 Accepted","Invitation 1 No response","Invitation 2 No response","Invitation 2 No response","Invitation 2 No response","Invitation 2 Accepted","Invitation 2 Declined","Invitation 2 No response","Invitation 3 Accepted","Invitation 3 Declined","Invitation 3 No response"],"to":["Invitation 1 Declined","Invitation 1 No response","Invitation 1 Accepted","Invitation 2 No response","Invitation 2 Accepted","Invitation 2 Declined","Declined","Accepted","No response","Invitation 3 Accepted","Invitation 3 Declined","Invitation 3 No response","Accepted","Declined","No response","Accepted","Declined","No response"],"flow":[15,77,8,46,12,8,15,8,11,9,10,14,12,8,13,9,10,14]},"columns":[{"id":"from","name":"from","type":["glue","character"]},{"id":"to","name":"to","type":["glue","character"]},{"id":"flow","name":"flow","type":"numeric"}],"defaultPageSize":5,"dataKey":"742d09c4727207338778e12e06444f4b"},"children":[]},"class":"reactR_markup"},"evals":[],"jsHooks":[]}</script>
<p>Flows of participants between milestones</p>
</div>
</div>
</section>
</section>
<section id="sankey-plot" class="level1">
<h1>Sankey plot</h1>
<p>We now have a neat little summary of movements of participants between the milestones in our recruitment pathway. However, this ‘tidy’ data isn’t the format required by <a href="https://plotly.com/r/sankey-diagram/">plotly</a>, so the next steps are to prepare it ready for plotting.</p>
<section id="preparing-for-plotly" class="level2">
<h2 class="anchored" data-anchor-id="preparing-for-plotly">Preparing for plotly</h2>
<p>Plotly expects to be fed two sets of data:</p>
<ol type="1">
<li><p>Nodes - these are the milestones we have in our <code>from</code> and <code>to</code> fields,</p></li>
<li><p>Edges - these are the flows that occur between nodes, the <code>flow</code> in our table.</p></li>
</ol>
<p>It is possible to extract this data by hand but I found using the <a href="https://tidygraph.data-imaginist.com">tidygraph</a> package was much easier and more convenient.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>df_sankey <span class="ot">&lt;-</span> df_flows <span class="sc">|&gt;</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># convert our flows data to a tidy graph object</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as_tbl_graph</span>()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>The tidygraph package splits our data into nodes and edges. We can selectively work on each by ‘activating’ them - here is the nodes list:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>df_sankey <span class="sc">|&gt;</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">activate</span>(<span class="at">what =</span> <span class="st">"nodes"</span>) <span class="sc">|&gt;</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as_tibble</span>() <span class="sc">|&gt;</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">reactable</span>(<span class="at">defaultPageSize =</span> <span class="dv">5</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div class="reactable html-widget html-fill-item" id="htmlwidget-c88b684aa59b7053a197" style="width:auto;height:auto;"></div>
<script type="application/json" data-for="htmlwidget-c88b684aa59b7053a197">{"x":{"tag":{"name":"Reactable","attribs":{"data":{"name":["Eligible population","Invitation 1 No response","Invitation 1 Declined","Invitation 1 Accepted","Invitation 2 No response","Invitation 2 Accepted","Invitation 2 Declined","Invitation 3 Accepted","Invitation 3 Declined","Invitation 3 No response","Declined","Accepted","No response"]},"columns":[{"id":"name","name":"name","type":"character"}],"defaultPageSize":5,"dataKey":"c8916df8221f76b5b09469d3a29a7b47"},"children":[]},"class":"reactR_markup"},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<p>You can see each unique node name listed. The row numbers for these nodes are used as reference IDs in the edges object:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>df_sankey <span class="sc">|&gt;</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">activate</span>(<span class="at">what =</span> <span class="st">"edges"</span>) <span class="sc">|&gt;</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as_tibble</span>() <span class="sc">|&gt;</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">reactable</span>(<span class="at">defaultPageSize =</span> <span class="dv">5</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div class="reactable html-widget html-fill-item" id="htmlwidget-61d01eb1917d40cdfca7" style="width:auto;height:auto;"></div>
<script type="application/json" data-for="htmlwidget-61d01eb1917d40cdfca7">{"x":{"tag":{"name":"Reactable","attribs":{"data":{"from":[1,1,1,2,2,2,3,4,2,5,5,5,6,7,5,8,9,10],"to":[3,2,4,5,6,7,11,12,13,8,9,10,12,11,13,12,11,13],"flow":[15,77,8,46,12,8,15,8,11,9,10,14,12,8,13,9,10,14]},"columns":[{"id":"from","name":"from","type":"numeric"},{"id":"to","name":"to","type":"numeric"},{"id":"flow","name":"flow","type":"numeric"}],"defaultPageSize":5,"dataKey":"a889e9b644c7e0f45f526b0ebde36ebd"},"children":[]},"class":"reactR_markup"},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<p>We now have enough information to generate our Sankey.</p>
<p>First we extract our nodes and edges to separate data frames then convert the ID values to be zero-based (starts at 0) as this is what plotly is expecting. To do this is as simple as subtracting 1 from the value of the IDs.</p>
<p>Finally we pass these two dataframes to plotly’s <code>node</code> and <code>link</code> function inputs to generate the plot.</p>
<div class="cell fig-cap-location-top">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb8" data-cap-location="top"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># extract the nodes to a dataframe</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>nodes <span class="ot">&lt;-</span> df_sankey <span class="sc">|&gt;</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">activate</span>(nodes) <span class="sc">|&gt;</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>() <span class="sc">|&gt;</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">id =</span> <span class="fu">row_number</span>() <span class="sc">-</span> <span class="dv">1</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a><span class="co"># extract the edges to a dataframe</span></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>edges <span class="ot">&lt;-</span> df_sankey <span class="sc">|&gt;</span></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">activate</span>(edges) <span class="sc">|&gt;</span></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>() <span class="sc">|&gt;</span></span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">from =</span> from <span class="sc">-</span> <span class="dv">1</span>,</span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">to =</span> to <span class="sc">-</span> <span class="dv">1</span></span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a><span class="co"># plot our sankey</span></span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_ly</span>(</span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a>  <span class="co"># setup</span></span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a>  <span class="at">type =</span> <span class="st">"sankey"</span>,</span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a>  <span class="at">orientation =</span> <span class="st">"h"</span>,</span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a>  <span class="at">arrangement =</span> <span class="st">"snap"</span>,</span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a>  <span class="co"># use our node data</span></span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a>  <span class="at">node =</span> <span class="fu">list</span>(</span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a>    <span class="at">label =</span> nodes<span class="sc">$</span>name</span>
<span id="cb8-28"><a href="#cb8-28" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb8-29"><a href="#cb8-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-30"><a href="#cb8-30" aria-hidden="true" tabindex="-1"></a>  <span class="co"># use our link data</span></span>
<span id="cb8-31"><a href="#cb8-31" aria-hidden="true" tabindex="-1"></a>  <span class="at">link =</span> <span class="fu">list</span>(</span>
<span id="cb8-32"><a href="#cb8-32" aria-hidden="true" tabindex="-1"></a>    <span class="at">source =</span> edges<span class="sc">$</span>from,</span>
<span id="cb8-33"><a href="#cb8-33" aria-hidden="true" tabindex="-1"></a>    <span class="at">target =</span> edges<span class="sc">$</span>to,</span>
<span id="cb8-34"><a href="#cb8-34" aria-hidden="true" tabindex="-1"></a>    <span class="at">value =</span> edges<span class="sc">$</span>flow</span>
<span id="cb8-35"><a href="#cb8-35" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb8-36"><a href="#cb8-36" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<div class="plotly html-widget html-fill-item" id="htmlwidget-81df00dabeaef98ceac6" style="width:672px;height:480px;"></div>
<script type="application/json" data-for="htmlwidget-81df00dabeaef98ceac6">{"x":{"visdat":{"617636d5c3ff":["function () ","plotlyVisDat"]},"cur_data":"617636d5c3ff","attrs":{"617636d5c3ff":{"orientation":"h","arrangement":"snap","node":{"label":["Eligible population","Invitation 1 No response","Invitation 1 Declined","Invitation 1 Accepted","Invitation 2 No response","Invitation 2 Accepted","Invitation 2 Declined","Invitation 3 Accepted","Invitation 3 Declined","Invitation 3 No response","Declined","Accepted","No response"]},"link":{"source":[0,0,0,1,1,1,2,3,1,4,4,4,5,6,4,7,8,9],"target":[2,1,3,4,5,6,10,11,12,7,8,9,11,10,12,11,10,12],"value":[15,77,8,46,12,8,15,8,11,9,10,14,12,8,13,9,10,14]},"alpha_stroke":1,"sizes":[10,100],"spans":[1,20],"type":"sankey"}},"layout":{"margin":{"b":40,"l":60,"t":25,"r":10},"hovermode":"closest","showlegend":false},"source":"A","config":{"modeBarButtonsToAdd":["hoverclosest","hovercompare"],"showSendToCloud":false},"data":[{"orientation":"h","arrangement":"snap","node":{"label":["Eligible population","Invitation 1 No response","Invitation 1 Declined","Invitation 1 Accepted","Invitation 2 No response","Invitation 2 Accepted","Invitation 2 Declined","Invitation 3 Accepted","Invitation 3 Declined","Invitation 3 No response","Declined","Accepted","No response"]},"link":{"source":[0,0,0,1,1,1,2,3,1,4,4,4,5,6,4,7,8,9],"target":[2,1,3,4,5,6,10,11,12,7,8,9,11,10,12,11,10,12],"value":[15,77,8,46,12,8,15,8,11,9,10,14,12,8,13,9,10,14]},"type":"sankey","frame":null}],"highlight":{"on":"plotly_click","persistent":false,"dynamic":false,"selectize":false,"opacityDim":0.20000000000000001,"selected":{"opacity":1},"debounce":0},"shinyEvents":["plotly_hover","plotly_click","plotly_selected","plotly_relayout","plotly_brushed","plotly_brushing","plotly_clickannotation","plotly_doubleclick","plotly_deselect","plotly_afterplot","plotly_sunburstclick"],"base_url":"https://plot.ly"},"evals":[],"jsHooks":[]}</script>
<p>Our first sankey</p>
</div>
</div>
<p>Not bad!</p>
<p>We can see the structure of our Sankey now. Can you see the relative proportions of participants who did or didn’t respond to our first invite? Marvel at how those who responded to the first invite flow into our final outcome. How about those who didn’t respond to the first invitation go on to receive a second invite?</p>
<p>Plotly’s charts are interactive. Try hovering your cursor over the nodes and edges to highlight them and a pop-up box will appear giving you additional details. You can reorder the vertical position of the nodes by dragging them above or below an adjacent node.</p>
<p>This looks functional.</p>
</section>
<section id="styling-our-sankey" class="level2">
<h2 class="anchored" data-anchor-id="styling-our-sankey">Styling our Sankey</h2>
<p>Now we have the foundations of our Sankey I’d like to move on to its presentation. Specifically I’d like to:</p>
<ul>
<li><p>use colour coding to clearly group those who accept or decline the invite,</p></li>
<li><p>improve the readability of the node titles,</p></li>
<li><p>add additional information to the pop-up boxes when you hover over nodes and edges, and</p></li>
<li><p>control the positioning of the nodes in the plot.</p></li>
</ul>
<p>As our <code>nodes</code> and <code>edges</code> objects are dataframes it is straightforward to add this styling information directly to them.</p>
<p>For the nodes object we define colours based on the name of each node and manually position them in the plot</p>
<div class="cell fig-cap-location-top">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb9" data-cap-location="top"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># get the eligible population as a single value</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="co"># NB, will be used to work out % amounts in each node and edge</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>temp_eligible_pop <span class="ot">&lt;-</span> df_flows <span class="sc">|&gt;</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(from <span class="sc">==</span> <span class="st">"Eligible population"</span>) <span class="sc">|&gt;</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">total =</span> <span class="fu">sum</span>(flow, <span class="at">na.rm =</span> T)) <span class="sc">|&gt;</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(total)</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a><span class="co"># style our nodes object</span></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>nodes <span class="ot">&lt;-</span> nodes <span class="sc">|&gt;</span></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># colour ----</span></span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>    <span class="co"># add colour definitions, green for accepted, red for declined</span></span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">colour =</span> <span class="fu">case_when</span>(</span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>      <span class="fu">str_detect</span>(name, <span class="st">"Accepted"</span>) <span class="sc">~</span> <span class="st">"#44bd32"</span>,</span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a>      <span class="fu">str_detect</span>(name, <span class="st">"Declined"</span>) <span class="sc">~</span> <span class="st">"#c23616"</span>,</span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>      <span class="fu">str_detect</span>(name, <span class="st">"No response"</span>) <span class="sc">~</span> <span class="st">"#7f8fa6"</span>,</span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a>      <span class="fu">str_detect</span>(name, <span class="st">"Eligible population"</span>) <span class="sc">~</span> <span class="st">"#7f8fa6"</span></span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a>    <span class="co"># add a semi-transparent colour for the edges based on node colours</span></span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">colour_fade =</span> <span class="fu">col2hcl</span>(<span class="at">colour =</span> colour, <span class="at">alpha =</span> <span class="fl">0.3</span>),</span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a>    <span class="co"># positioning ----</span></span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true" tabindex="-1"></a>    <span class="co"># NB, I found that to position nodes you need to supply both</span></span>
<span id="cb9-25"><a href="#cb9-25" aria-hidden="true" tabindex="-1"></a>    <span class="co"># horizontal and vertical positions</span></span>
<span id="cb9-26"><a href="#cb9-26" aria-hidden="true" tabindex="-1"></a>    <span class="co"># NNB, it was a bit of trial and error to get the these positions just</span></span>
<span id="cb9-27"><a href="#cb9-27" aria-hidden="true" tabindex="-1"></a>    <span class="co"># right</span></span>
<span id="cb9-28"><a href="#cb9-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-29"><a href="#cb9-29" aria-hidden="true" tabindex="-1"></a>    <span class="co"># horizontal positions (0 = left, 1 = right)</span></span>
<span id="cb9-30"><a href="#cb9-30" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="fu">case_when</span>(</span>
<span id="cb9-31"><a href="#cb9-31" aria-hidden="true" tabindex="-1"></a>      <span class="fu">str_detect</span>(name, <span class="st">"Eligible population"</span>) <span class="sc">~</span> <span class="dv">1</span>,</span>
<span id="cb9-32"><a href="#cb9-32" aria-hidden="true" tabindex="-1"></a>      <span class="fu">str_detect</span>(name, <span class="st">"Invitation 1"</span>) <span class="sc">~</span> <span class="dv">2</span>,</span>
<span id="cb9-33"><a href="#cb9-33" aria-hidden="true" tabindex="-1"></a>      <span class="fu">str_detect</span>(name, <span class="st">"Invitation 2"</span>) <span class="sc">~</span> <span class="dv">3</span>,</span>
<span id="cb9-34"><a href="#cb9-34" aria-hidden="true" tabindex="-1"></a>      <span class="fu">str_detect</span>(name, <span class="st">"Invitation 3"</span>) <span class="sc">~</span> <span class="dv">4</span>,</span>
<span id="cb9-35"><a href="#cb9-35" aria-hidden="true" tabindex="-1"></a>      <span class="at">.default =</span> <span class="dv">5</span></span>
<span id="cb9-36"><a href="#cb9-36" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span> <span class="fu">rescale</span>(<span class="at">to =</span> <span class="fu">c</span>(<span class="fl">0.001</span>, <span class="fl">0.9</span>)),</span>
<span id="cb9-37"><a href="#cb9-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-38"><a href="#cb9-38" aria-hidden="true" tabindex="-1"></a>    <span class="co"># vertical position (1 = bottom, 0 = top)</span></span>
<span id="cb9-39"><a href="#cb9-39" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="fu">case_when</span>(</span>
<span id="cb9-40"><a href="#cb9-40" aria-hidden="true" tabindex="-1"></a>      <span class="fu">str_detect</span>(name, <span class="st">"Eligible population"</span>) <span class="sc">~</span> <span class="dv">5</span>,</span>
<span id="cb9-41"><a href="#cb9-41" aria-hidden="true" tabindex="-1"></a>      <span class="co"># invite 1</span></span>
<span id="cb9-42"><a href="#cb9-42" aria-hidden="true" tabindex="-1"></a>      <span class="fu">str_detect</span>(name, <span class="st">"Invitation 1 Accepted"</span>) <span class="sc">~</span> <span class="dv">1</span>,</span>
<span id="cb9-43"><a href="#cb9-43" aria-hidden="true" tabindex="-1"></a>      <span class="fu">str_detect</span>(name, <span class="st">"Invitation 1 No response"</span>) <span class="sc">~</span> <span class="dv">5</span>,</span>
<span id="cb9-44"><a href="#cb9-44" aria-hidden="true" tabindex="-1"></a>      <span class="fu">str_detect</span>(name, <span class="st">"Invitation 1 Declined"</span>) <span class="sc">~</span> <span class="fl">8.5</span>,</span>
<span id="cb9-45"><a href="#cb9-45" aria-hidden="true" tabindex="-1"></a>      <span class="co"># invite 2</span></span>
<span id="cb9-46"><a href="#cb9-46" aria-hidden="true" tabindex="-1"></a>      <span class="fu">str_detect</span>(name, <span class="st">"Invitation 2 Accepted"</span>) <span class="sc">~</span> <span class="dv">2</span>,</span>
<span id="cb9-47"><a href="#cb9-47" aria-hidden="true" tabindex="-1"></a>      <span class="fu">str_detect</span>(name, <span class="st">"Invitation 2 No response"</span>) <span class="sc">~</span> <span class="dv">5</span>,</span>
<span id="cb9-48"><a href="#cb9-48" aria-hidden="true" tabindex="-1"></a>      <span class="fu">str_detect</span>(name, <span class="st">"Invitation 2 Declined"</span>) <span class="sc">~</span> <span class="fl">7.8</span>,</span>
<span id="cb9-49"><a href="#cb9-49" aria-hidden="true" tabindex="-1"></a>      <span class="co"># invite 3</span></span>
<span id="cb9-50"><a href="#cb9-50" aria-hidden="true" tabindex="-1"></a>      <span class="fu">str_detect</span>(name, <span class="st">"Invitation 3 Accepted"</span>) <span class="sc">~</span> <span class="fl">2.7</span>,</span>
<span id="cb9-51"><a href="#cb9-51" aria-hidden="true" tabindex="-1"></a>      <span class="fu">str_detect</span>(name, <span class="st">"Invitation 3 No response"</span>) <span class="sc">~</span> <span class="fl">5.8</span>,</span>
<span id="cb9-52"><a href="#cb9-52" aria-hidden="true" tabindex="-1"></a>      <span class="fu">str_detect</span>(name, <span class="st">"Invitation 3 Declined"</span>) <span class="sc">~</span> <span class="fl">7.2</span>,</span>
<span id="cb9-53"><a href="#cb9-53" aria-hidden="true" tabindex="-1"></a>      <span class="co"># final outcomes</span></span>
<span id="cb9-54"><a href="#cb9-54" aria-hidden="true" tabindex="-1"></a>      <span class="fu">str_detect</span>(name, <span class="st">"Accepted"</span>) <span class="sc">~</span> <span class="dv">1</span>,</span>
<span id="cb9-55"><a href="#cb9-55" aria-hidden="true" tabindex="-1"></a>      <span class="fu">str_detect</span>(name, <span class="st">"No response"</span>) <span class="sc">~</span> <span class="dv">5</span>,</span>
<span id="cb9-56"><a href="#cb9-56" aria-hidden="true" tabindex="-1"></a>      <span class="fu">str_detect</span>(name, <span class="st">"Declined"</span>) <span class="sc">~</span> <span class="dv">8</span>,</span>
<span id="cb9-57"><a href="#cb9-57" aria-hidden="true" tabindex="-1"></a>      <span class="at">.default =</span> <span class="dv">5</span></span>
<span id="cb9-58"><a href="#cb9-58" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span> <span class="fu">rescale</span>(<span class="at">to =</span> <span class="fu">c</span>(<span class="fl">0.001</span>, <span class="fl">0.999</span>))</span>
<span id="cb9-59"><a href="#cb9-59" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb9-60"><a href="#cb9-60" aria-hidden="true" tabindex="-1"></a>  <span class="co"># add in a custom field to show the percentage flow</span></span>
<span id="cb9-61"><a href="#cb9-61" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(</span>
<span id="cb9-62"><a href="#cb9-62" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> df_flows <span class="sc">|&gt;</span></span>
<span id="cb9-63"><a href="#cb9-63" aria-hidden="true" tabindex="-1"></a>      <span class="fu">group_by</span>(to) <span class="sc">|&gt;</span></span>
<span id="cb9-64"><a href="#cb9-64" aria-hidden="true" tabindex="-1"></a>      <span class="fu">summarise</span>(</span>
<span id="cb9-65"><a href="#cb9-65" aria-hidden="true" tabindex="-1"></a>        <span class="at">flow =</span> <span class="fu">sum</span>(flow, <span class="at">na.rm =</span> T),</span>
<span id="cb9-66"><a href="#cb9-66" aria-hidden="true" tabindex="-1"></a>        <span class="at">flow_perc =</span> <span class="fu">percent</span>(flow <span class="sc">/</span> temp_eligible_pop, <span class="at">accuracy =</span> <span class="fl">0.1</span>),</span>
<span id="cb9-67"><a href="#cb9-67" aria-hidden="true" tabindex="-1"></a>      ) <span class="sc">|&gt;</span></span>
<span id="cb9-68"><a href="#cb9-68" aria-hidden="true" tabindex="-1"></a>      <span class="fu">select</span>(<span class="at">name =</span> to, flow_perc),</span>
<span id="cb9-69"><a href="#cb9-69" aria-hidden="true" tabindex="-1"></a>    <span class="at">by =</span> <span class="st">"name"</span></span>
<span id="cb9-70"><a href="#cb9-70" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb9-71"><a href="#cb9-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-72"><a href="#cb9-72" aria-hidden="true" tabindex="-1"></a><span class="co"># view our nodes data</span></span>
<span id="cb9-73"><a href="#cb9-73" aria-hidden="true" tabindex="-1"></a>nodes <span class="sc">|&gt;</span></span>
<span id="cb9-74"><a href="#cb9-74" aria-hidden="true" tabindex="-1"></a>  <span class="fu">reactable</span>(<span class="at">defaultPageSize =</span> <span class="dv">5</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<div class="reactable html-widget html-fill-item" id="htmlwidget-f7768febd5ad0e1a4493" style="width:auto;height:auto;"></div>
<script type="application/json" data-for="htmlwidget-f7768febd5ad0e1a4493">{"x":{"tag":{"name":"Reactable","attribs":{"data":{"name":["Eligible population","Invitation 1 No response","Invitation 1 Declined","Invitation 1 Accepted","Invitation 2 No response","Invitation 2 Accepted","Invitation 2 Declined","Invitation 3 Accepted","Invitation 3 Declined","Invitation 3 No response","Declined","Accepted","No response"],"id":[0,1,2,3,4,5,6,7,8,9,10,11,12],"colour":["#7f8fa6","#7f8fa6","#c23616","#44bd32","#7f8fa6","#44bd32","#c23616","#44bd32","#c23616","#7f8fa6","#c23616","#44bd32","#7f8fa6"],"colour_fade":["#7F8FA64C","#7F8FA64C","#C236164C","#44BD324C","#7F8FA64C","#44BD324C","#C236164C","#44BD324C","#C236164C","#7F8FA64C","#C236164C","#44BD324C","#7F8FA64C"],"x":[0.001,0.22575,0.22575,0.22575,0.4505,0.4505,0.4505,0.67525,0.67525,0.67525,0.9,0.9,0.9],"y":[0.533266666666667,0.533266666666667,0.999,0.001,0.533266666666667,0.134066666666667,0.905853333333333,0.227213333333333,0.826013333333333,0.63972,0.932466666666667,0.001,0.533266666666667],"flow_perc":[null,"77.0%","15.0%","8.0%","46.0%","12.0%","8.0%","9.0%","10.0%","14.0%","33.0%","29.0%","38.0%"]},"columns":[{"id":"name","name":"name","type":["glue","character"]},{"id":"id","name":"id","type":"numeric"},{"id":"colour","name":"colour","type":"character"},{"id":"colour_fade","name":"colour_fade","type":"character"},{"id":"x","name":"x","type":"numeric"},{"id":"y","name":"y","type":"numeric"},{"id":"flow_perc","name":"flow_perc","type":"character"}],"defaultPageSize":5,"dataKey":"846bee5df8dbde8324fb073f5cfd1799"},"children":[]},"class":"reactR_markup"},"evals":[],"jsHooks":[]}</script>
<p>Styling the nodes dataframe</p>
</div>
</div>
<p>Next we move to styling the edges, which is a much simpler prospect:</p>
<div class="cell fig-cap-location-top">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb10" data-cap-location="top"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>edges <span class="ot">&lt;-</span> edges <span class="sc">|&gt;</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>    <span class="co"># add a label for each flow to tell us how many people are in each</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">label =</span> <span class="fu">number</span>(flow, <span class="at">big.mark =</span> <span class="st">","</span>),</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># add a percentage flow figure</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">flow_perc =</span> <span class="fu">percent</span>(flow <span class="sc">/</span> temp_eligible_pop, <span class="at">accuracy =</span> <span class="fl">0.1</span>)</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>  <span class="co"># add the faded colour from our nodes object to match the destinations</span></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> nodes <span class="sc">|&gt;</span> <span class="fu">select</span>(<span class="at">to =</span> id, colour_fade),</span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">by =</span> <span class="st">"to"</span></span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a><span class="co"># view our edges data</span></span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>edges <span class="sc">|&gt;</span></span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">reactable</span>(<span class="at">defaultPageSize =</span> <span class="dv">5</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<div class="reactable html-widget html-fill-item" id="htmlwidget-c34880ede9aa21e663fa" style="width:auto;height:auto;"></div>
<script type="application/json" data-for="htmlwidget-c34880ede9aa21e663fa">{"x":{"tag":{"name":"Reactable","attribs":{"data":{"from":[0,0,0,1,1,1,2,3,1,4,4,4,5,6,4,7,8,9],"to":[2,1,3,4,5,6,10,11,12,7,8,9,11,10,12,11,10,12],"flow":[15,77,8,46,12,8,15,8,11,9,10,14,12,8,13,9,10,14],"label":["15","77","8","46","12","8","15","8","11","9","10","14","12","8","13","9","10","14"],"flow_perc":["15.0%","77.0%","8.0%","46.0%","12.0%","8.0%","15.0%","8.0%","11.0%","9.0%","10.0%","14.0%","12.0%","8.0%","13.0%","9.0%","10.0%","14.0%"],"colour_fade":["#C236164C","#7F8FA64C","#44BD324C","#7F8FA64C","#44BD324C","#C236164C","#C236164C","#44BD324C","#7F8FA64C","#44BD324C","#C236164C","#7F8FA64C","#44BD324C","#C236164C","#7F8FA64C","#44BD324C","#C236164C","#7F8FA64C"]},"columns":[{"id":"from","name":"from","type":"numeric"},{"id":"to","name":"to","type":"numeric"},{"id":"flow","name":"flow","type":"numeric"},{"id":"label","name":"label","type":"character"},{"id":"flow_perc","name":"flow_perc","type":"character"},{"id":"colour_fade","name":"colour_fade","type":"character"}],"defaultPageSize":5,"dataKey":"adb0410c463383f1a7998a47c33b6495"},"children":[]},"class":"reactR_markup"},"evals":[],"jsHooks":[]}</script>
<p>Styling the edges dataframe</p>
</div>
</div>
<p>We now have stylised node and edge tables ready and can bring it all together. Note the use of <code>customdata</code> and <code>hovertemplate</code> help to bring in additional information and styling to the pop-up boxes that appear when you hover over each flow and node.</p>
<div class="cell fig-cap-location-top">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb11" data-cap-location="top"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co"># plot our stylised sankey</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_ly</span>(</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># setup</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">type =</span> <span class="st">"sankey"</span>,</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">orientation =</span> <span class="st">"h"</span>,</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">arrangement =</span> <span class="st">"snap"</span>,</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>  <span class="co"># use our node data</span></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">node =</span> <span class="fu">list</span>(</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">label =</span> nodes<span class="sc">$</span>name,</span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> nodes<span class="sc">$</span>colour,</span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> nodes<span class="sc">$</span>x,</span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> nodes<span class="sc">$</span>y,</span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">customdata =</span> nodes<span class="sc">$</span>flow_perc,</span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">hovertemplate =</span> <span class="st">"%{label}&lt;br /&gt;&lt;b&gt;%{value}&lt;/b&gt; participants&lt;br /&gt;&lt;b&gt;%{customdata}&lt;/b&gt; of eligible population"</span></span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a>  <span class="co"># use our edge data</span></span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a>  <span class="at">link =</span> <span class="fu">list</span>(</span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">source =</span> edges<span class="sc">$</span>from,</span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">target =</span> edges<span class="sc">$</span>to,</span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">value =</span> edges<span class="sc">$</span>flow,</span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">label =</span> edges<span class="sc">$</span>label,</span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> edges<span class="sc">$</span>colour_fade,</span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true" tabindex="-1"></a>    <span class="at">customdata =</span> edges<span class="sc">$</span>flow_perc,</span>
<span id="cb11-26"><a href="#cb11-26" aria-hidden="true" tabindex="-1"></a>    <span class="at">hovertemplate =</span> <span class="st">"%{source.label} → %{target.label}&lt;br /&gt;&lt;b&gt;%{value}&lt;/b&gt; participants&lt;br /&gt;&lt;b&gt;%{customdata}&lt;/b&gt; of eligible population"</span></span>
<span id="cb11-27"><a href="#cb11-27" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb11-28"><a href="#cb11-28" aria-hidden="true" tabindex="-1"></a>) <span class="sc">|&gt;</span></span>
<span id="cb11-29"><a href="#cb11-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">layout</span>(</span>
<span id="cb11-30"><a href="#cb11-30" aria-hidden="true" tabindex="-1"></a>    <span class="at">font =</span> <span class="fu">list</span>(</span>
<span id="cb11-31"><a href="#cb11-31" aria-hidden="true" tabindex="-1"></a>      <span class="at">family =</span> <span class="st">"Arial, Helvetica, sans-serif"</span>,</span>
<span id="cb11-32"><a href="#cb11-32" aria-hidden="true" tabindex="-1"></a>      <span class="at">size =</span> <span class="dv">12</span></span>
<span id="cb11-33"><a href="#cb11-33" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb11-34"><a href="#cb11-34" aria-hidden="true" tabindex="-1"></a>    <span class="co"># make the background transparent (also removes the text shadow)</span></span>
<span id="cb11-35"><a href="#cb11-35" aria-hidden="true" tabindex="-1"></a>    <span class="at">paper_bgcolor =</span> <span class="st">"rgba(0,0,0,0)"</span></span>
<span id="cb11-36"><a href="#cb11-36" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb11-37"><a href="#cb11-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">config</span>(<span class="at">responsive =</span> T)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<div class="plotly html-widget html-fill-item" id="htmlwidget-5915d3e9ad0239c93ab1" style="width:672px;height:480px;"></div>
<script type="application/json" data-for="htmlwidget-5915d3e9ad0239c93ab1">{"x":{"visdat":{"6176529af01b":["function () ","plotlyVisDat"]},"cur_data":"6176529af01b","attrs":{"6176529af01b":{"orientation":"h","arrangement":"snap","node":{"label":["Eligible population","Invitation 1 No response","Invitation 1 Declined","Invitation 1 Accepted","Invitation 2 No response","Invitation 2 Accepted","Invitation 2 Declined","Invitation 3 Accepted","Invitation 3 Declined","Invitation 3 No response","Declined","Accepted","No response"],"color":["#7f8fa6","#7f8fa6","#c23616","#44bd32","#7f8fa6","#44bd32","#c23616","#44bd32","#c23616","#7f8fa6","#c23616","#44bd32","#7f8fa6"],"x":[0.001,0.22575000000000001,0.22575000000000001,0.22575000000000001,0.45050000000000001,0.45050000000000001,0.45050000000000001,0.67525000000000002,0.67525000000000002,0.67525000000000002,0.90000000000000002,0.90000000000000002,0.90000000000000002],"y":[0.53326666666666667,0.53326666666666667,0.999,0.001,0.53326666666666667,0.13406666666666667,0.90585333333333329,0.22721333333333335,0.82601333333333338,0.63972000000000007,0.93246666666666667,0.001,0.53326666666666667],"customdata":[null,"77.0%","15.0%","8.0%","46.0%","12.0%","8.0%","9.0%","10.0%","14.0%","33.0%","29.0%","38.0%"],"hovertemplate":"%{label}<br /><b>%{value}<\/b> participants<br /><b>%{customdata}<\/b> of eligible population"},"link":{"source":[0,0,0,1,1,1,2,3,1,4,4,4,5,6,4,7,8,9],"target":[2,1,3,4,5,6,10,11,12,7,8,9,11,10,12,11,10,12],"value":[15,77,8,46,12,8,15,8,11,9,10,14,12,8,13,9,10,14],"label":["15","77","8","46","12","8","15","8","11","9","10","14","12","8","13","9","10","14"],"color":["#C236164C","#7F8FA64C","#44BD324C","#7F8FA64C","#44BD324C","#C236164C","#C236164C","#44BD324C","#7F8FA64C","#44BD324C","#C236164C","#7F8FA64C","#44BD324C","#C236164C","#7F8FA64C","#44BD324C","#C236164C","#7F8FA64C"],"customdata":["15.0%","77.0%","8.0%","46.0%","12.0%","8.0%","15.0%","8.0%","11.0%","9.0%","10.0%","14.0%","12.0%","8.0%","13.0%","9.0%","10.0%","14.0%"],"hovertemplate":"%{source.label} → %{target.label}<br /><b>%{value}<\/b> participants<br /><b>%{customdata}<\/b> of eligible population"},"alpha_stroke":1,"sizes":[10,100],"spans":[1,20],"type":"sankey"}},"layout":{"margin":{"b":40,"l":60,"t":25,"r":10},"font":{"family":"Arial, Helvetica, sans-serif","size":12},"paper_bgcolor":"rgba(0,0,0,0)","hovermode":"closest","showlegend":false},"source":"A","config":{"modeBarButtonsToAdd":["hoverclosest","hovercompare"],"showSendToCloud":false,"responsive":true},"data":[{"orientation":"h","arrangement":"snap","node":{"label":["Eligible population","Invitation 1 No response","Invitation 1 Declined","Invitation 1 Accepted","Invitation 2 No response","Invitation 2 Accepted","Invitation 2 Declined","Invitation 3 Accepted","Invitation 3 Declined","Invitation 3 No response","Declined","Accepted","No response"],"color":["#7f8fa6","#7f8fa6","#c23616","#44bd32","#7f8fa6","#44bd32","#c23616","#44bd32","#c23616","#7f8fa6","#c23616","#44bd32","#7f8fa6"],"x":[0.001,0.22575000000000001,0.22575000000000001,0.22575000000000001,0.45050000000000001,0.45050000000000001,0.45050000000000001,0.67525000000000002,0.67525000000000002,0.67525000000000002,0.90000000000000002,0.90000000000000002,0.90000000000000002],"y":[0.53326666666666667,0.53326666666666667,0.999,0.001,0.53326666666666667,0.13406666666666667,0.90585333333333329,0.22721333333333335,0.82601333333333338,0.63972000000000007,0.93246666666666667,0.001,0.53326666666666667],"customdata":[null,"77.0%","15.0%","8.0%","46.0%","12.0%","8.0%","9.0%","10.0%","14.0%","33.0%","29.0%","38.0%"],"hovertemplate":"%{label}<br /><b>%{value}<\/b> participants<br /><b>%{customdata}<\/b> of eligible population"},"link":{"source":[0,0,0,1,1,1,2,3,1,4,4,4,5,6,4,7,8,9],"target":[2,1,3,4,5,6,10,11,12,7,8,9,11,10,12,11,10,12],"value":[15,77,8,46,12,8,15,8,11,9,10,14,12,8,13,9,10,14],"label":["15","77","8","46","12","8","15","8","11","9","10","14","12","8","13","9","10","14"],"color":["#C236164C","#7F8FA64C","#44BD324C","#7F8FA64C","#44BD324C","#C236164C","#C236164C","#44BD324C","#7F8FA64C","#44BD324C","#C236164C","#7F8FA64C","#44BD324C","#C236164C","#7F8FA64C","#44BD324C","#C236164C","#7F8FA64C"],"customdata":["15.0%","77.0%","8.0%","46.0%","12.0%","8.0%","15.0%","8.0%","11.0%","9.0%","10.0%","14.0%","12.0%","8.0%","13.0%","9.0%","10.0%","14.0%"],"hovertemplate":"%{source.label} → %{target.label}<br /><b>%{value}<\/b> participants<br /><b>%{customdata}<\/b> of eligible population"},"type":"sankey","frame":null}],"highlight":{"on":"plotly_click","persistent":false,"dynamic":false,"selectize":false,"opacityDim":0.20000000000000001,"selected":{"opacity":1},"debounce":0},"shinyEvents":["plotly_hover","plotly_click","plotly_selected","plotly_relayout","plotly_brushed","plotly_brushing","plotly_clickannotation","plotly_doubleclick","plotly_deselect","plotly_afterplot","plotly_sunburstclick"],"base_url":"https://plot.ly"},"evals":[],"jsHooks":[]}</script>
<p>A stylish Sankey</p>
</div>
</div>
</section>
</section>
<section id="conclusion" class="level1">
<h1>Conclusion</h1>
<p>Creating Sankey plots in R using plotly is an effective way to visualise patient pathways.</p>
<p>In our project we embedded Sankey plots within an interactive <a href="https://shiny.posit.co/">Shiny</a> app which allows for selective filters that update the resulting plot. This allowed us to quickly compare the effects of different models of delivering the screening programme, geography, deprivation levels, patient demographic, or any combination of these.</p>
<p>Their use has helped the programme team better understand patient flows through the pathway, where the points of drop-off are and compare / contrast the effects of different models of delivering the screening programme on patient engagement.</p>
<p>Feedback from external stakeholders has been positive too, noting how easy it is to engage with and understand this style of presentation.</p>
<p>In this blog post we have wrangled a dataset to describe how people flow between steps in a process and then produced a Sankey diagram with some stylistic touches to make an effective visualisation.</p>
<p>I hope this post helps you feel better prepared to use Sankeys in your work.</p>


</section>


</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    // Ensure there is a toggle, if there isn't float one in the top right
    if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
      const a = window.document.createElement('a');
      a.classList.add('top-right');
      a.classList.add('quarto-color-scheme-toggle');
      a.href = "";
      a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
      const i = window.document.createElement("i");
      i.classList.add('bi');
      a.appendChild(i);
      window.document.body.appendChild(a);
    }
    setColorSchemeToggle(hasAlternateSentinel())
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("https:\/\/the-strategy-unit\.github\.io\/data_science");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




<footer class="footer"><div class="nav-footer"><div class="nav-footer-center"><div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/the-strategy-unit/data_science/edit/main/blogs/posts/2024-02-28_sankey_plot/index.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/the-strategy-unit/data_science/issues/new" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></div></div></footer></body></html>